apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-nextcloud-config
data:
  config.php: |
    <?php
    $CONFIG = array (
      'datadirectory' => '{{ .Values.nextcloud.datadir }}',
      'dbtype' => '{{ .Values.externalDatabase.type }}',
      'dbname' => '{{ .Values.externalDatabase.database }}',
      'dbhost' => '{{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }}',
      'dbuser' => '{{ .Values.externalDatabase.user }}',
      'dbpassword' => '{{ .Values.externalDatabase.password }}',
      'overwrite.cli.url' => 'http://nextcloud-nextcloud.default.svc.cluster.local',
      'installed' => false,
      'memcache.local' => '\\OC\\Memcache\\Redis',
      'memcache.locking' => '\\OC\\Memcache\\Redis',
      'memcache.distributed' => '\\OC\\Memcache\\Redis',
      'redis' => array(
        'host' => '{{ .Values.redis.host }}',
        'port' => {{ .Values.redis.port }},
        'password' => '{{ .Values.redis.password }}',
      ),
    );
  custom-entrypoint.sh: |
    #!/bin/sh
    # Custom entrypoint to bypass redis-session.ini creation
    echo "Starting Nextcloud with custom entrypoint..."
    # Ensure data directory permissions
    chown -R www-data:www-data {{ .Values.nextcloud.datadir }}
    chmod -R 755 {{ .Values.nextcloud.datadir }}
    # Run Nextcloud setup if not installed
    if [ ! -f "{{ .Values.nextcloud.datadir }}/config.php" ]; then
      echo "Running Nextcloud installation..."
      php /var/www/html/occ maintenance:install \
        --database={{ .Values.externalDatabase.type }} \
        --database-host={{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }} \
        --database-name={{ .Values.externalDatabase.database }} \
        --database-user={{ .Values.externalDatabase.user }} \
        --database-pass={{ .Values.externalDatabase.password }} \
        --admin-user={{ .Values.nextcloud.adminUser }} \
        --admin-pass={{ .Values.nextcloud.adminPassword }} \
        --data-dir={{ .Values.nextcloud.datadir }}
    fi
    # Start Apache
    echo "Starting Apache..."
    exec apache2-foreground