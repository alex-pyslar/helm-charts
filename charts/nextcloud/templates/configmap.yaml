apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-nextcloud-config
data:
  config.php: |
    <?php
    $CONFIG = array (
      'datadirectory' => '{{ .Values.nextcloud.datadir }}',
      'dbtype' => '{{ .Values.externalDatabase.type }}',
      'dbname' => '{{ .Values.externalDatabase.database }}',
      'dbhost' => '{{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }}',
      'dbuser' => '{{ .Values.externalDatabase.user }}',
      'dbpassword' => '{{ .Values.externalDatabase.password }}',
      'overwrite.cli.url' => 'http://nextcloud-nextcloud.default.svc.cluster.local:8080',
      'trusted_domains' => array (
        0 => 'localhost',
        1 => 'nextcloud-nextcloud.default.svc.cluster.local',
        2 => 'nextcloud.velesoft.ru',
      ),
      'installed' => false,
      'memcache.local' => '\\OC\\Memcache\\Redis',
      'memcache.locking' => '\\OC\\Memcache\\Redis',
      'memcache.distributed' => '\\OC\\Memcache\\Redis',
      'redis' => array(
        'host' => '{{ .Values.redis.host }}',
        'port' => {{ .Values.redis.port }},
        'password' => '{{ .Values.redis.password }}',
      ),
    );
  custom-entrypoint.sh: |
    #!/bin/sh
    # Custom entrypoint to bypass redis-session.ini creation
    echo "Starting Nextcloud with custom entrypoint..."
    # Ensure directory permissions
    echo "Checking permissions for /var/www/html and {{ .Values.nextcloud.datadir }}..."
    chown -R www-data:www-data /var/www/html {{ .Values.nextcloud.datadir }}
    chmod -R 755 /var/www/html {{ .Values.nextcloud.datadir }}
    ls -ld /var/www/html {{ .Values.nextcloud.datadir }}
    # Debug: Check Apache port configuration
    echo "Checking Apache port configuration..."
    cat /etc/apache2/ports.conf
    # Debug: Check if occ exists
    if [ -f "/var/www/html/occ" ]; then
      echo "Found /var/www/html/occ"
      OCC_COMMAND="/var/www/html/occ"
    else
      echo "ERROR: /var/www/html/occ not found, using index.php occ"
      OCC_COMMAND="/var/www/html/index.php occ"
    fi
    # Run Nextcloud setup if not installed
    if [ ! -f "{{ .Values.nextcloud.datadir }}/config.php" ]; then
      echo "Running Nextcloud installation..."
      php $OCC_COMMAND maintenance:install \
        --database={{ .Values.externalDatabase.type }} \
        --database-host={{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }} \
        --database-name={{ .Values.externalDatabase.database }} \
        --database-user={{ .Values.externalDatabase.user }} \
        --database-pass={{ .Values.externalDatabase.password }} \
        --admin-user={{ .Values.nextcloud.adminUser }} \
        --admin-pass={{ .Values.nextcloud.adminPassword }} \
        --data-dir={{ .Values.nextcloud.datadir }}
    fi
    # Start Apache
    echo "Starting Apache on port 8080..."
    exec apache2-foreground
  ports.conf: |
    Listen 8080
    <IfModule ssl_module>
        Listen 443
    </IfModule>
    <IfModule mod_gnutls.c>
        Listen 443
    </IfModule>